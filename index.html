import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from 'firebase/firestore';
import { Settings, Plus, Copy, Eye, Calculator, Trash2, Save, X, FileText, CheckCircle2, ChevronDown, History, AlertCircle, UserCheck } from 'lucide-react';

// =========================================================================
// --- 貼上您的金鑰 ---
// 請從 Firebase Console 複製您的配置物件內容替換到下方的 {} 內
// =========================================================================
const firebaseConfig = {
  apiKey: "AIzaSyASRHQ9_sQouh09cRwYTOe7ktc2CNdhXyQ",
  authDomain: "h320-6cea5.firebaseapp.com",
  projectId: "h320-6cea5",
  storageBucket: "h320-6cea5.firebasestorage.app",
  messagingSenderId: "701831421016",
  appId: "1:701831421016:web:2c6093f786f9a96d643e2d"
};

// 初始化 Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "shang-hao-zhong-v5"; 

export default function App() {
  const [user, setUser] = useState(null);
  const [customers, setCustomers] = useState([]);
  const [selectedCustomerId, setSelectedCustomerId] = useState('');
  const [allCurrentRecords, setAllCurrentRecords] = useState([]);
  const [allHistoryRecords, setAllHistoryRecords] = useState([]);
  
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [isSheetOpen, setIsSheetOpen] = useState(false);
  const [view, setView] = useState('current');
  
  // 結帳與歷史明細狀態
  const [isSettleModalOpen, setIsSettleModalOpen] = useState(false);
  const [cashierName, setCashierName] = useState('');
  const [historyDetailItem, setHistoryDetailItem] = useState(null);
  
  // 對話框與通知
  const [modalConfig, setModalConfig] = useState({ show: false, title: '', message: '', onConfirm: null });
  const [toast, setToast] = useState({ show: false, message: '' });

  // 1. 初始化驗證
  useEffect(() => {
    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (err) {
        showToast('雲端驗證失敗，請檢查金鑰設定');
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. 監聽 Firestore 數據
  useEffect(() => {
    if (!user) return;

    const custPath = collection(db, 'artifacts', appId, 'users', user.uid, 'customers');
    const unsubCust = onSnapshot(custPath, (snap) => {
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setCustomers(list);
      if (list.length > 0 && !selectedCustomerId) setSelectedCustomerId(list[0].id);
    });

    const currentPath = collection(db, 'artifacts', appId, 'users', user.uid, 'currentRecords');
    const unsubCurrent = onSnapshot(currentPath, (snap) => {
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setAllCurrentRecords(list);
    });

    const historyPath = collection(db, 'artifacts', appId, 'users', user.uid, 'historyRecords');
    const unsubHistory = onSnapshot(historyPath, (snap) => {
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setAllHistoryRecords(list);
    });

    return () => { unsubCust(); unsubCurrent(); unsubHistory(); };
  }, [user]);

  // --- 計算邏輯 ---
  const currentRecords = useMemo(() => {
    return allCurrentRecords
      .filter(r => r.customerId === selectedCustomerId)
      .sort((a, b) => a.timestamp - b.timestamp);
  }, [allCurrentRecords, selectedCustomerId]);

  const historyRecords = useMemo(() => {
    return allHistoryRecords
      .filter(h => h.customerId === selectedCustomerId)
      .sort((a, b) => b.settledAt - a.settledAt);
  }, [allHistoryRecords, selectedCustomerId]);

  const calculateRebateValue = (r) => {
    const bet = parseFloat(r.bet) || 0;
    const rebatePercent = parseFloat(r.rebatePercent) || 0;
    const roundedBet = Math.floor(bet / 1000) * 1000;
    return (roundedBet * (rebatePercent / 100));
  };

  const calculateItemTotal = (r) => {
    return (
      (parseFloat(r.prevBalance) || 0) +
      (parseFloat(r.deposit) || 0) -
      (parseFloat(r.bet) || 0) +
      (parseFloat(r.prize) || 0) +
      (parseFloat(r.adjustment) || 0) +
      calculateRebateValue(r)
    );
  };

  const chainedRecords = useMemo(() => {
    let lastTotal = 0;
    return currentRecords.map((r, i) => {
      const prev = i === 0 ? (parseFloat(r.prevBalance) || 0) : lastTotal;
      const current = { ...r, prevBalance: prev };
      lastTotal = calculateItemTotal(current);
      return current;
    });
  }, [currentRecords]);

  const finalTotal = chainedRecords.length > 0 ? calculateItemTotal(chainedRecords[chainedRecords.length - 1]) : 0;

  // --- 操作功能 ---
  const showToast = (msg) => {
    setToast({ show: true, message: msg });
    setTimeout(() => setToast({ show: false, message: '' }), 3000);
  };

  const openConfirm = (title, message, onConfirm) => {
    setModalConfig({ show: true, title, message, onConfirm });
  };

  const handleAddCustomer = async (e) => {
    e.preventDefault();
    if (!user) return;
    const nameInput = document.getElementById('nName');
    const rebateInput = document.getElementById('nRebate');
    if (!nameInput.value) return;

    try {
      const custPath = collection(db, 'artifacts', appId, 'users', user.uid, 'customers');
      const docRef = await addDoc(custPath, {
        name: nameInput.value,
        defaultRebate: parseFloat(rebateInput.value) || 0,
        createdAt: Date.now()
      });
      setSelectedCustomerId(docRef.id);
      nameInput.value = ''; rebateInput.value = '';
      setIsSettingsOpen(false);
      showToast('顧客已新增');
    } catch (err) { showToast('新增失敗'); }
  };

  const handleDeleteCustomer = (id, name) => {
    openConfirm('刪除顧客', `確定要刪除「${name}」嗎？這會連同歷史紀錄一起移除。`, async () => {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'customers', id));
      setSelectedCustomerId('');
      showToast('已刪除');
    });
  };

  const addNewRecord = async () => {
    if (!user || !selectedCustomerId) return;
    const nextPrev = chainedRecords.length > 0 ? calculateItemTotal(chainedRecords[chainedRecords.length - 1]) : 0;
    const cust = customers.find(c => c.id === selectedCustomerId);

    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'currentRecords'), {
      customerId: selectedCustomerId,
      timestamp: Date.now(),
      time: new Date().toTimeString().substring(0, 5),
      prevBalance: nextPrev,
      deposit: 0, bet: 0, prize: 0,
      rebatePercent: cust?.defaultRebate || 0,
      adjustment: 0
    });
  };

  const updateRecord = async (id, field, value) => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'currentRecords', id);
    await updateDoc(docRef, { [field]: field === 'time' ? value : (parseFloat(value) || 0) });
  };

  const deleteRecord = (id) => {
    openConfirm('刪除項目', '確定要刪除此帳務項目嗎？', async () => {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'currentRecords', id));
      showToast('項目已刪除');
    });
  };

  const confirmSettle = async () => {
    if (!cashierName.trim()) { showToast('請填寫人員姓名'); return; }

    try {
      const historyPath = collection(db, 'artifacts', appId, 'users', user.uid, 'historyRecords');
      await addDoc(historyPath, {
        customerId: selectedCustomerId,
        settledAt: Date.now(),
        settledBy: cashierName,
        date: new Date().toLocaleDateString(),
        records: JSON.stringify(chainedRecords),
        total: finalTotal
      });

      for (const r of currentRecords) {
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'currentRecords', r.id));
      }
      setIsSettleModalOpen(false); setIsSheetOpen(false); setCashierName('');
      showToast('結帳完成，已存入歷史紀錄！');
    } catch (e) { showToast('結帳發生錯誤'); }
  };

  const handleDeleteHistory = async (historyId) => {
    openConfirm('刪除紀錄', '確定要刪除這筆歷史結算紀錄嗎？', async () => {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'historyRecords', historyId));
      setHistoryDetailItem(null);
      showToast('歷史紀錄已刪除');
    });
  };

  const copyToClipboard = () => {
    const customer = customers.find(c => c.id === selectedCustomerId) || { name: "未命名" };
    let text = `【尚好中運動彩券行-顧客對帳單】\n`;
    text += `顧客：${customer.name}\n日期：${new Date().toLocaleDateString()}\n`;
    text += `--------------------------\n`;
    chainedRecords.forEach((r, i) => {
      text += `#${i+1} 帳務資訊 (${r.time})\n`;
      text += `  原餘額：$${Math.round(r.prevBalance).toLocaleString()}\n`;
      text += `  今日轉存：+ $${r.deposit.toLocaleString()}\n`;
      text += `  投注金額：- $${r.bet.toLocaleString()}\n`;
      text += `  兌獎金額：+ $${r.prize.toLocaleString()}\n`;
      text += `  回饋點數：+ $${Math.round(calculateRebateValue(r)).toLocaleString()}\n`;
      if (r.adjustment !== 0) text += `  調整金額：${r.adjustment > 0 ? '+' : ''} $${r.adjustment.toLocaleString()}\n`;
      text += `  本項結餘：$${Math.round(calculateItemTotal(r)).toLocaleString()}\n`;
      text += `--------------------------\n`;
    });
    text += `目前總結餘：$ ${Math.round(finalTotal).toLocaleString()}`;

    const el = document.createElement('textarea');
    el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
    showToast('已複製明細內容');
  };

  // 統整歷史明細數據
  const historySummary = useMemo(() => {
    if (!historyDetailItem) return null;
    const records = JSON.parse(historyDetailItem.records);
    const totals = records.reduce((acc, r) => {
      acc.deposit += (r.deposit || 0);
      acc.bet += (r.bet || 0);
      acc.prize += (r.prize || 0);
      acc.rebate += calculateRebateValue(r);
      acc.adjustment += (r.adjustment || 0);
      return acc;
    }, { deposit: 0, bet: 0, prize: 0, rebate: 0, adjustment: 0 });
    return { firstPrev: records[0]?.prevBalance || 0, ...totals };
  }, [historyDetailItem]);

  if (!user) return <div className="h-screen flex items-center justify-center bg-slate-50 text-slate-400 font-black">系統連線中...</div>;

  return (
    <div className="min-h-screen bg-slate-50 pb-48 font-sans text-slate-900 antialiased">
      {toast.show && (
        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[200] bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl animate-in fade-in zoom-in">{toast.message}</div>
      )}

      {/* Header */}
      <div className="sticky top-0 z-40 bg-white/90 px-4 py-5 backdrop-blur-md shadow-sm border-b">
        <div className="mx-auto max-w-md flex justify-between items-center mb-4">
          <div className="flex items-center gap-2">
            <div className="bg-blue-600 p-2 rounded-xl text-white flex items-center justify-center"><Calculator size={20} /></div>
            <h1 className="text-lg font-black tracking-tight">尚好中運動彩券行-顧客帳務資訊</h1>
          </div>
          <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className="p-2.5 bg-slate-100 rounded-full text-slate-600 active:scale-90 transition-transform"><Settings size={20} /></button>
        </div>

        <div className="mx-auto max-w-md flex gap-2 items-center">
          <div className="relative flex-1 min-w-[130px]">
            <select 
              className="w-full bg-slate-100 border-none rounded-xl text-sm font-bold p-2.5 focus:ring-2 focus:ring-blue-500 shadow-sm pr-10 appearance-none"
              value={selectedCustomerId}
              onChange={(e) => setSelectedCustomerId(e.target.value)}
            >
              {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
            <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"><ChevronDown size={18} /></div>
          </div>
          <div className="flex bg-slate-100 p-1 rounded-xl shrink-0">
            <button onClick={() => setView('current')} className={`px-5 py-1.5 rounded-lg text-xs font-black transition ${view === 'current' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>目前帳務</button>
            <button onClick={() => setView('history')} className={`px-5 py-1.5 rounded-lg text-xs font-black transition ${view === 'history' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>歷史紀錄</button>
          </div>
        </div>
      </div>

      <div className="mx-auto max-w-md p-4 space-y-4">
        {/* Settings Area */}
        {isSettingsOpen && (
          <div className="bg-white p-6 rounded-3xl shadow-xl border border-slate-100 animate-in fade-in duration-300">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-sm font-black text-slate-700">管理顧客清單</h3>
              <button onClick={() => setIsSettingsOpen(false)} className="text-slate-300"><X size={16}/></button>
            </div>
            <form onSubmit={handleAddCustomer} className="space-y-4">
              <div className="grid grid-cols-2 gap-3">
                <input id="nName" type="text" placeholder="顧客姓名" className="bg-slate-50 border-none p-3.5 rounded-xl text-sm ring-1 ring-slate-100" required />
                <input id="nRebate" type="number" step="0.01" placeholder="回饋%" className="bg-slate-50 border-none p-3.5 rounded-xl text-sm ring-1 ring-slate-100" />
              </div>
              <button type="submit" className="w-full bg-blue-600 text-white py-3.5 rounded-2xl text-sm font-black shadow-lg">確認新增</button>
            </form>
            <div className="mt-6 border-t pt-4 space-y-2 max-h-48 overflow-y-auto no-scrollbar">
              {customers.map(c => (
                <div key={c.id} className="flex justify-between items-center bg-slate-50 p-3 rounded-xl">
                  <span className="text-xs font-bold">{c.name} ({c.defaultRebate}%)</span>
                  <button onClick={() => handleDeleteCustomer(c.id, c.name)} className="text-slate-300 hover:text-red-500"><Trash2 size={14}/></button>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Current View */}
        {view === 'current' ? (
          <div className="space-y-6">
            {chainedRecords.map((r, i) => (
              <div key={r.id} className="bg-white rounded-[2.5rem] p-6 shadow-sm border border-slate-100 space-y-5 relative overflow-hidden group">
                <div className="absolute top-0 left-0 w-2.5 h-full bg-blue-600"></div>
                <div className="flex justify-between items-center border-b pb-4">
                  <span className="font-black text-slate-900 text-lg">#{i + 1} 帳務資訊</span>
                  <div className="flex items-center gap-2">
                    <input type="time" value={r.time} onChange={(e) => updateRecord(r.id, 'time', e.target.value)} className="bg-slate-100 border-none rounded-lg p-1.5 text-xs font-bold focus:ring-0" />
                    <button onClick={() => deleteRecord(r.id)} className="text-slate-200 hover:text-red-400 p-1"><Trash2 size={18} /></button>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="col-span-2 space-y-1.5">
                    <label className="text-[10px] font-black text-slate-400 uppercase">原餘額 (連動)</label>
                    <input type="number" value={r.prevBalance} readOnly={i > 0} onFocus={(e) => e.target.select()} onChange={(e) => updateRecord(r.id, 'prevBalance', e.target.value)} className={`w-full text-xl font-black p-4 rounded-2xl border-none ring-1 ring-slate-100 ${i > 0 ? 'bg-slate-50 text-slate-400' : 'bg-white text-slate-900'}`} />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-[10px] font-black text-blue-600 uppercase">今日轉存 (+)</label>
                    <input type="number" defaultValue={r.deposit} onFocus={(e) => e.target.select()} onBlur={(e) => updateRecord(r.id, 'deposit', e.target.value)} className="w-full text-xl font-black p-4 rounded-2xl border-none ring-1 ring-blue-50 bg-blue-50/20 text-blue-700" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-[10px] font-black text-red-500 uppercase">投注金額 (-)</label>
                    <input type="number" defaultValue={r.bet} onFocus={(e) => e.target.select()} onBlur={(e) => updateRecord(r.id, 'bet', e.target.value)} className="w-full text-xl font-black p-4 rounded-2xl border-none ring-1 ring-red-50 bg-red-50/20 text-red-600" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-[10px] font-black text-emerald-600 uppercase">兌獎金額 (+)</label>
                    <input type="number" defaultValue={r.prize} onFocus={(e) => e.target.select()} onBlur={(e) => updateRecord(r.id, 'prize', e.target.value)} className="w-full text-xl font-black p-4 rounded-2xl border-none ring-1 ring-emerald-50 bg-emerald-50/20 text-emerald-700" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-[10px] font-black text-purple-600 uppercase">回饋點數 %</label>
                    <input type="number" step="0.01" defaultValue={r.rebatePercent} onFocus={(e) => e.target.select()} onBlur={(e) => updateRecord(r.id, 'rebatePercent', e.target.value)} className="w-full text-xl font-black p-4 rounded-2xl border-none ring-1 ring-purple-50 bg-purple-50/20 text-purple-700" />
                  </div>
                  <div className="space-y-1.5 col-span-2">
                    <label className="text-[10px] font-black text-purple-400 uppercase tracking-widest">回饋點數 $ (自動)</label>
                    <input type="number" readOnly value={Math.round(calculateRebateValue(r))} className="w-full text-xl font-black p-4 rounded-2xl border-none ring-1 ring-slate-100 bg-slate-50 text-purple-500" />
                  </div>
                  <div className="space-y-1.5 col-span-2">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">調整 (±)</label>
                    <input type="number" defaultValue={r.adjustment} onFocus={(e) => e.target.select()} onBlur={(e) => updateRecord(r.id, 'adjustment', e.target.value)} className="w-full text-xl font-black p-4 rounded-2xl border-none ring-1 ring-slate-100 bg-slate-50 text-slate-700" />
                  </div>
                </div>
                <div className="pt-5 border-t flex justify-between items-center">
                  <div className="flex flex-col">
                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">本項合計小計</span>
                    <span className="text-3xl font-black tracking-tighter text-slate-900">$ {Math.round(calculateItemTotal(r)).toLocaleString()}</span>
                  </div>
                  <div className="p-3 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center"><Calculator size={24} /></div>
                </div>
              </div>
            ))}
            <button onClick={addNewRecord} className="w-full border-2 border-dashed border-slate-300 py-12 rounded-[2.5rem] text-slate-400 font-black flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform shadow-sm"><Plus size={40} /><span className="text-sm">新增帳務項目卡片</span></button>
          </div>
        ) : (
          /* 歷史紀錄 View */
          <div className="space-y-4">
            {historyRecords.length === 0 && <div className="text-center py-20 text-slate-300 font-bold flex flex-col items-center gap-2"><History size={48} className="opacity-10" />尚無歷史結帳紀錄</div>}
            {historyRecords.map(h => (
              <div key={h.id} onClick={() => setHistoryDetailItem(h)} className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex justify-between items-center active:scale-95 transition-transform cursor-pointer group">
                <div>
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{h.date}</p>
                  <p className="text-xs text-slate-500 font-bold flex items-center gap-1"><FileText size={12}/> {h.settledBy ? `人員: ${h.settledBy}` : '包含紀錄結算'}</p>
                </div>
                <div className="text-right">
                  <p className="text-2xl font-black text-blue-700 tracking-tighter leading-none mb-1">$ {Math.round(h.total).toLocaleString()}</p>
                  <p className="text-[10px] font-bold text-slate-300 uppercase">{new Date(h.settledAt).toLocaleTimeString()}</p>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Sticky Bottom Bar */}
      <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-2xl border-t p-6 z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.06)]">
        <div className="mx-auto max-w-md flex justify-between items-center gap-3">
          <div className="flex-1">
            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">目前總結餘</span>
            <span className="text-3xl font-black text-blue-700 tracking-tighter leading-none">$ {Math.round(finalTotal).toLocaleString()}</span>
          </div>
          <div className="flex gap-2 shrink-0">
            <button onClick={() => setIsSheetOpen(true)} className="px-8 py-4 bg-slate-800 text-white rounded-2xl font-black text-xs shadow-lg active:scale-90 transition-transform flex items-center justify-center gap-2"><Eye size={16}/> 明細</button>
            <button onClick={() => setIsSettleModalOpen(true)} className="px-8 py-4 bg-green-600 text-white rounded-2xl font-black text-xs shadow-lg active:scale-90 transition-transform flex items-center justify-center gap-2 shadow-green-100"><Save size={16}/> 結帳</button>
          </div>
        </div>
      </div>

      {/* 電子帳單 Bottom Sheet */}
      {isSheetOpen && (
        <div className="fixed inset-0 z-[100] flex items-end">
          <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm animate-in fade-in" onClick={() => setIsSheetOpen(false)}></div>
          <div className="relative w-full bg-white rounded-t-[3.5rem] p-10 shadow-2xl max-h-[85vh] overflow-y-auto animate-in slide-in-from-bottom-full duration-300">
            <div className="w-16 h-1.5 bg-slate-100 rounded-full mx-auto mb-10"></div>
            <div className="flex justify-between items-center mb-8">
              <div><h2 className="text-2xl font-black tracking-tighter text-slate-800 tracking-tight">電子對帳單明細</h2><p className="text-xs font-bold text-slate-400 mt-1">顧客：{customers.find(c => c.id === selectedCustomerId)?.name}</p></div>
              <button onClick={() => setIsSheetOpen(false)} className="p-3 bg-slate-50 rounded-full text-slate-400 flex items-center justify-center active:bg-slate-100 transition-colors"><X size={24}/></button>
            </div>
            <div className="space-y-6 mb-10">
              {chainedRecords.map((r, i) => (
                <div key={r.id} className="bg-slate-50 p-6 rounded-3xl space-y-3 border border-slate-100 shadow-sm">
                  <div className="flex justify-between items-center pb-2 border-b border-slate-200"><p className="font-black text-slate-800 text-lg tracking-tight">#{i+1} 帳務資訊</p><p className="text-[10px] font-bold text-slate-400">{r.time} 記錄</p></div>
                  <div className="grid grid-cols-2 gap-y-2 text-xs font-bold text-slate-600">
                    <p>原餘額：</p><p className="text-right">${Math.round(r.prevBalance).toLocaleString()}</p>
                    <p>今日轉存：</p><p className="text-right text-blue-600">+ ${r.deposit.toLocaleString()}</p>
                    <p>投注金額：</p><p className="text-right text-red-500">- ${r.bet.toLocaleString()}</p>
                    <p>兌獎金額：</p><p className="text-right text-emerald-600">+ ${r.prize.toLocaleString()}</p>
                    <p>回饋點數：</p><p className="text-right text-purple-600">+ ${Math.round(calculateRebateValue(r)).toLocaleString()}</p>
                    {r.adjustment !== 0 && <React.Fragment><p>調整金額：</p><p className="text-right text-slate-400">{r.adjustment > 0 ? '+' : ''}${r.adjustment.toLocaleString()}</p></React.Fragment>}
                  </div>
                  <div className="flex justify-between items-center pt-2 border-t border-slate-200 mt-1"><p className="text-sm font-black text-slate-800 tracking-tight">#{i+1} 結餘：</p><p className="text-xl font-black text-slate-900 tracking-tighter leading-none">$ {Math.round(calculateItemTotal(r)).toLocaleString()}</p></div>
                </div>
              ))}
            </div>
            <div className="bg-blue-600 p-8 rounded-[2.5rem] flex justify-between items-center mb-8 shadow-xl text-white shadow-blue-100"><span className="text-xl font-black tracking-tight uppercase">目前總結餘</span><span className="text-4xl font-black tracking-tighter leading-none">$ {Math.round(finalTotal).toLocaleString()}</span></div>
            <div className="grid grid-cols-1 gap-3">
              <button onClick={copyToClipboard} className="py-5 bg-slate-100 text-slate-800 font-black rounded-3xl flex items-center justify-center gap-3 active:scale-95 transition-transform"><Copy size={20}/> 複製文字明細</button>
              <button onClick={() => setIsSettleModalOpen(true)} className="py-5 bg-green-600 text-white font-black rounded-3xl flex items-center justify-center gap-3 active:scale-95 transition-transform shadow-xl shadow-green-50"><CheckCircle2 size={20}/> 確認並結帳</button>
            </div>
          </div>
        </div>
      )}

      {/* 結帳人員必填 Modal */}
      {isSettleModalOpen && (
        <div className="fixed inset-0 z-[300] flex items-center justify-center p-6">
          <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={() => setIsSettleModalOpen(false)}></div>
          <div className="relative w-full max-w-sm bg-white rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in duration-200">
            <div className="flex items-center gap-3 text-blue-600 mb-4"><UserCheck size={28} /><h3 className="text-xl font-black">結帳歸檔確認</h3></div>
            <p className="text-slate-500 font-bold mb-6 text-sm">請輸入結帳人員姓名 (必填)：</p>
            <input type="text" value={cashierName} onChange={(e) => setCashierName(e.target.value)} placeholder="例如：阿中" className="w-full bg-slate-50 border-none p-4 rounded-2xl text-lg font-bold ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 mb-8 outline-none" autoFocus />
            <div className="flex gap-3">
              <button onClick={() => setIsSettleModalOpen(false)} className="flex-1 py-4 bg-slate-100 text-slate-400 font-black rounded-2xl active:scale-95">取消</button>
              <button onClick={confirmSettle} className="flex-1 py-4 bg-blue-600 text-white font-black rounded-2xl shadow-lg active:scale-95">確定結帳</button>
            </div>
          </div>
        </div>
      )}

      {/* 歷史紀錄統整詳情 Modal */}
      {historyDetailItem && historySummary && (
        <div className="fixed inset-0 z-[250] flex items-center justify-center p-6">
          <div className="absolute inset-0 bg-slate-900/70 backdrop-blur-md" onClick={() => setHistoryDetailItem(null)}></div>
          <div className="relative w-full max-w-md bg-white rounded-[3rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto animate-in zoom-in duration-300 no-scrollbar">
            <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black text-slate-800">歷史結算統整</h3><button onClick={() => setHistoryDetailItem(null)} className="p-2 bg-slate-100 rounded-full flex items-center justify-center"><X size={20}/></button></div>
            <div className="bg-slate-50 p-5 rounded-3xl mb-8 border border-slate-100 space-y-2 text-xs font-bold text-slate-500">
              <div className="flex justify-between"><span>對帳日期</span><span className="text-slate-800">{historyDetailItem.date}</span></div>
              <div className="flex justify-between"><span>結帳人員</span><span className="text-blue-600 font-black">{historyDetailItem.settledBy || '系統歸檔'}</span></div>
              <div className="flex justify-between"><span>結帳時間</span><span className="text-slate-800">{new Date(historyDetailItem.settledAt).toLocaleTimeString()}</span></div>
            </div>
            
            <div className="space-y-4 mb-8 px-2">
              <div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-400 uppercase tracking-widest">首項原餘額</span><span className="font-black text-slate-800 tracking-tight">${Math.round(historySummary.firstPrev).toLocaleString()}</span></div>
              <div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-400 uppercase tracking-widest">總今日轉存 (+)</span><span className="font-black text-blue-600 tracking-tight">+ ${historySummary.deposit.toLocaleString()}</span></div>
              <div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-400 uppercase tracking-widest">總投注金額 (-)</span><span className="font-black text-red-500 tracking-tight">- ${historySummary.bet.toLocaleString()}</span></div>
              <div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-400 uppercase tracking-widest">總兌獎金額 (+)</span><span className="font-black text-emerald-600 tracking-tight">+ ${historySummary.prize.toLocaleString()}</span></div>
              <div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-400 uppercase tracking-widest">總回饋點數 (+)</span><span className="font-black text-purple-600 tracking-tight">+ ${Math.round(historySummary.rebate).toLocaleString()}</span></div>
              {historySummary.adjustment !== 0 && <div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-400 uppercase tracking-widest">總調整金額 (±)</span><span className="font-black text-slate-600 tracking-tight">{historySummary.adjustment > 0 ? '+' : ''}${historySummary.adjustment.toLocaleString()}</span></div>}
              <div className="h-px bg-slate-100 my-4"></div>
            </div>

            <div className="bg-blue-600 p-8 rounded-[2.5rem] flex justify-between items-center text-white shadow-xl shadow-blue-100"><span className="text-lg font-black uppercase">總計結餘</span><span className="text-3xl font-black tracking-tighter leading-none">${Math.round(historyDetailItem.total).toLocaleString()}</span></div>
            
            <div className="mt-8 flex flex-col gap-3">
              <button onClick={() => handleDeleteHistory(historyDetailItem.id)} className="w-full py-4 border-2 border-red-50 text-red-500 font-bold rounded-2xl flex items-center justify-center gap-2 active:bg-red-50 transition-colors"><Trash2 size={18} /> 刪除此歷史紀錄</button>
              <button onClick={() => setHistoryDetailItem(null)} className="w-full py-5 bg-slate-800 text-white font-black rounded-3xl active:scale-95 transition-transform">關閉視窗</button>
            </div>
          </div>
        </div>
      )}

      {/* 確認彈窗 */}
      {modalConfig.show && (
        <div className="fixed inset-0 z-[300] flex items-center justify-center p-6">
          <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={() => setModalConfig({ ...modalConfig, show: false })}></div>
          <div className="relative w-full max-w-sm bg-white rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in duration-200">
            <div className="flex items-center gap-3 text-red-500 mb-4"><AlertCircle size={28} /><h3 className="text-xl font-black">{modalConfig.title}</h3></div>
            <p className="text-slate-600 font-bold mb-8 leading-relaxed text-sm">{modalConfig.message}</p>
            <div className="flex gap-3">
              <button onClick={() => setModalConfig({ ...modalConfig, show: false })} className="flex-1 py-4 bg-slate-100 text-slate-400 font-black rounded-2xl active:scale-95">取消</button>
              <button onClick={() => { modalConfig.onConfirm(); setModalConfig({ ...modalConfig, show: false }); }} className="flex-1 py-4 bg-blue-600 text-white font-black rounded-2xl shadow-lg active:scale-95">確定</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
